# 🧪 测试系统使用指南

## 📋 系统概述

我们已经建立了完整的测试和性能监控系统，包括：

### ✅ 测试框架组件
- **Jest测试框架** - 现代化的JavaScript/TypeScript测试框架
- **Supertest集成测试** - HTTP API端点测试
- **测试数据库** - 隔离的测试环境
- **Mock和Stub** - 外部依赖模拟
- **性能基准测试** - 响应时间和吞吐量测试
- **代码覆盖率报告** - 测试覆盖度分析

### 🔍 监控系统组件
- **实时性能监控** - 请求响应时间追踪
- **健康检查端点** - 系统状态监控
- **错误追踪** - 错误率和异常监控
- **资源使用监控** - 内存、CPU使用情况
- **端点性能分析** - 各API端点性能统计

## 🚀 快速开始

### 1. 环境准备

```bash
# 安装测试依赖
pnpm install

# 创建测试数据库
createdb inspirations_test

# 配置测试环境变量（如果.env.test被阻止，手动配置）
export NODE_ENV=test
export TEST_DATABASE_URL=postgresql://test:test@localhost:5432/inspirations_test
export JWT_SECRET=test-jwt-secret-key
```

### 2. 运行测试

```bash
# 运行所有测试
pnpm test

# 运行并监听文件变化
pnpm test:watch

# 运行测试并生成覆盖率报告
pnpm test:coverage

# 运行特定类型的测试
pnpm test:unit        # 单元测试
pnpm test:integration # 集成测试
pnpm test:e2e        # 端到端测试
```

## 🧪 测试类型详解

### 1. 单元测试 (Unit Tests)

**位置**: `tests/unit/`  
**目的**: 测试单个函数、类或模块的逻辑

**示例运行**:
```bash
# 运行认证服务单元测试
pnpm test tests/unit/auth.service.test.ts

# 输出示例:
✓ 应该成功注册新用户
✓ 邮箱已存在时应该抛出错误
✓ 密码应该被正确加密
✓ 正确凭据应该成功登录
✓ 错误密码应该抛出错误
```

**覆盖功能**:
- 用户注册和登录逻辑
- 密码加密和验证
- JWT令牌生成和验证
- 数据验证和错误处理

### 2. 集成测试 (Integration Tests)

**位置**: `tests/integration/`  
**目的**: 测试API端点的完整请求-响应流程

**示例运行**:
```bash
# 运行API集成测试
pnpm test tests/integration/

# 示例输出:
Ideas API 集成测试
  GET /api/ideas
    ✓ 应该返回灵感列表 (45ms)
    ✓ 应该支持分页参数 (32ms)
    ✓ 应该支持标签筛选 (28ms)
  POST /api/ideas
    ✓ 认证用户应该能创建灵感 (67ms)
    ✓ 未认证用户应该无法创建灵感 (12ms)

Auth API 集成测试
  POST /api/auth/register
    ✓ 应该成功注册新用户 (89ms)
    ✓ 重复邮箱应该返回400错误 (23ms)
```

**覆盖功能**:
- 所有API端点的HTTP请求测试
- 认证和授权流程测试
- 数据输入验证测试
- 错误响应格式测试

### 3. 性能基准测试 (Performance Tests)

**位置**: `tests/performance/`  
**目的**: 验证系统性能指标和稳定性

**示例运行**:
```bash
# 运行性能测试
pnpm test tests/performance/benchmark.test.ts

# 示例输出:
📊 获取灵感列表: 123.45ms
📊 创建新灵感: 234.67ms
📊 用户认证验证: 45.23ms
📊 10个并发读取请求: 456.78ms
📊 平均每请求: 45.68ms
```

**测试指标**:
- API响应时间基准 (< 200-500ms)
- 并发请求处理能力
- 缓存效果验证
- 大数据量查询性能
- 系统压力测试

## 📊 性能监控系统

### 1. 实时监控端点

```bash
# 基础健康检查
curl http://localhost:3001/api/monitoring/health

# 系统状态检查
curl http://localhost:3001/api/monitoring/status

# 详细性能报告（需要管理员权限）
curl http://localhost:3001/api/monitoring/performance \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"

# 系统详细信息
curl http://localhost:3001/api/monitoring/system \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

### 2. 性能报告示例

```json
{
  "success": true,
  "data": {
    "overview": {
      "uptime": "2.5 hours",
      "totalRequests": 1250,
      "averageResponseTime": "145.67ms",
      "slowRequests": 23,
      "slowRequestRate": "1.84%",
      "errorCount": 8,
      "errorRate": "0.64%",
      "requestsPerHour": 500
    },
    "endpoints": [
      {
        "endpoint": "GET /api/ideas",
        "requests": 456,
        "averageTime": 123.45,
        "slowRequests": 5,
        "slowRequestRate": 1.1
      }
    ],
    "warnings": [
      {
        "type": "performance",
        "level": "warning",
        "message": "端点 POST /api/ai/enhance 平均响应时间较高: 856.78ms"
      }
    ]
  }
}
```

### 3. 监控仪表板功能

- **实时性能指标** - 请求数、响应时间、错误率
- **端点分析** - 各API端点的详细性能统计
- **错误追踪** - 错误类型、频率和趋势
- **资源监控** - 内存使用、数据库连接状态
- **预警系统** - 性能阈值超标自动警告

## 🎯 测试最佳实践

### 1. 编写测试用例

```typescript
describe('功能模块测试', () => {
  // 每个测试前的准备工作
  beforeEach(async () => {
    await cleanDatabase()
    testUser = await createTestUser()
  })

  it('应该能完成特定功能', async () => {
    // Arrange - 准备测试数据
    const testData = { /* 测试数据 */ }

    // Act - 执行被测试的操作
    const result = await serviceFunction(testData)

    // Assert - 验证结果
    expect(result).toHaveProperty('expectedProperty')
    expect(result.value).toBe(expectedValue)
  })

  // 测试后清理
  afterEach(async () => {
    await cleanupTestData()
  })
})
```

### 2. Mock外部依赖

```typescript
// Mock OpenRouter API
jest.mock('@/services/openRouterService', () => ({
  enhanceContent: jest.fn().mockResolvedValue({
    enhanced: '增强后的内容'
  }),
  summarizeContent: jest.fn().mockResolvedValue({
    summary: '内容摘要'
  })
}))

// Mock Redis缓存
jest.mock('@/config/redis', () => ({
  cacheService: {
    get: jest.fn(),
    set: jest.fn(),
    del: jest.fn()
  }
}))
```

### 3. 测试数据管理

```typescript
// 使用测试工具函数
const testUser = await testUtils.createTestUser({
  email: 'test@example.com',
  name: '测试用户'
})

const testIdea = await testUtils.createTestIdea(testUser.id, {
  content: '测试灵感内容',
  tags: ['测试', 'API']
})
```

## 🔧 CI/CD集成

### 1. GitHub Actions示例

```yaml
name: Test Suite
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_DB: inspirations_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Run tests
        run: pnpm test:coverage
        env:
          NODE_ENV: test
          TEST_DATABASE_URL: postgresql://postgres:test@localhost:5432/inspirations_test
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

### 2. 预提交钩子

```bash
# 安装husky
pnpm add -D husky

# 设置预提交测试
npx husky add .husky/pre-commit "pnpm test:unit"
npx husky add .husky/pre-push "pnpm test"
```

## 📈 性能优化建议

### 1. 基于测试结果的优化

```typescript
// 示例：缓存优化
if (performance.averageResponseTime > 500) {
  // 添加缓存层
  const cacheKey = `ideas:${JSON.stringify(queryParams)}`
  const cachedResult = await cacheService.get(cacheKey)
  
  if (cachedResult) {
    return cachedResult
  }
  
  const result = await expensiveOperation()
  await cacheService.set(cacheKey, result, 300)
  return result
}
```

### 2. 数据库查询优化

```typescript
// 基于性能测试发现的慢查询优化
const optimizedQuery = await prisma.idea.findMany({
  select: {
    id: true,
    content: true,
    author: {
      select: { id: true, name: true } // 只选择需要的字段
    }
  },
  take: limit,
  skip: (page - 1) * limit,
  orderBy: { createdAt: 'desc' }
})
```

## 🎯 测试覆盖率目标

### 当前目标 (jest.config.js)
- **分支覆盖率**: 70%
- **函数覆盖率**: 70%
- **行覆盖率**: 70%
- **语句覆盖率**: 70%

### 查看覆盖率报告

```bash
# 生成覆盖率报告
pnpm test:coverage

# 打开HTML报告
open coverage/lcov-report/index.html
```

## ⚠️ 故障排查

### 常见测试问题

1. **数据库连接失败**
   ```bash
   # 检查测试数据库
   psql -h localhost -U test -d inspirations_test -c "SELECT 1;"
   
   # 重新初始化测试数据库
   dropdb inspirations_test && createdb inspirations_test
   ```

2. **Jest配置问题**
   ```bash
   # 清除Jest缓存
   npx jest --clearCache
   
   # 运行单个测试文件调试
   npx jest tests/unit/auth.service.test.ts --verbose
   ```

3. **Mock失效问题**
   ```typescript
   // 在测试后恢复所有mock
   afterEach(() => {
     jest.restoreAllMocks()
   })
   ```

4. **性能测试不稳定**
   ```bash
   # 单独运行性能测试
   pnpm test tests/performance/ --runInBand --detectOpenHandles
   ```

### 调试技巧

```typescript
// 启用详细日志
process.env.LOG_LEVEL = 'debug'

// 使用debugger
it('调试测试', async () => {
  debugger; // 在这里设置断点
  const result = await testFunction()
  console.log('调试信息:', result)
})
```

## 🎉 测试成功标志

当以下指标达标时，说明测试系统运行良好：

✅ **单元测试覆盖率** > 70%  
✅ **集成测试** 所有API端点通过  
✅ **性能测试** 响应时间符合基准  
✅ **监控系统** 实时数据正常  
✅ **错误率** < 1%  
✅ **慢请求比例** < 5%  
✅ **系统健康检查** 通过  

## 📚 进阶功能

### 1. 自定义测试工具
- 创建业务特定的测试辅助函数
- 实现测试数据工厂模式
- 添加自定义Jest匹配器

### 2. 性能回归测试
- 建立性能基线数据库
- 自动化性能回归检测
- 性能趋势分析和报告

### 3. 测试环境自动化
- Docker化测试环境
- 测试数据自动生成和清理
- 并行测试执行优化

**恭喜！您现在拥有了企业级的测试和监控系统！** 🧪✨

这个系统确保了代码质量、性能稳定性和系统可靠性，为生产环境部署提供了坚实的保障。
