# JWTè®¤è¯ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ” ç³»ç»Ÿæ¦‚è¿°

æˆ‘ä»¬å·²ç»æˆåŠŸå®ç°äº†å®Œæ•´çš„JWTè®¤è¯ç³»ç»Ÿï¼Œæ”¯æŒï¼š

### âœ… æ ¸å¿ƒåŠŸèƒ½
- **ç”¨æˆ·æ³¨å†Œ** - å®‰å…¨çš„ç”¨æˆ·è´¦æˆ·åˆ›å»º
- **ç”¨æˆ·ç™»å½•** - JWTä»¤ç‰Œç”Ÿæˆå’ŒéªŒè¯
- **ä»¤ç‰Œåˆ·æ–°** - è‡ªåŠ¨å»¶é•¿ä¼šè¯æœ‰æ•ˆæœŸ
- **å¯†ç ç®¡ç†** - å®‰å…¨çš„å¯†ç ä¿®æ”¹å’Œé‡ç½®
- **ç”¨æˆ·ä¿¡æ¯ç®¡ç†** - ä¸ªäººèµ„æ–™æ›´æ–°
- **è§’è‰²æƒé™æ§åˆ¶** - åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
- **ä¼šè¯ç®¡ç†** - å®Œæ•´çš„ç™»å½•çŠ¶æ€è¿½è¸ª

### ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§
- **å¯†ç åŠ å¯†** - bcryptå“ˆå¸ŒåŠ ç›å­˜å‚¨
- **JWTä»¤ç‰Œ** - å®‰å…¨çš„è®¿é—®ä»¤ç‰Œå’Œåˆ·æ–°ä»¤ç‰Œ
- **ä»¤ç‰Œè¿‡æœŸ** - è‡ªåŠ¨è¿‡æœŸå’Œåˆ·æ–°æœºåˆ¶
- **ç”¨æˆ·çŠ¶æ€éªŒè¯** - å®æ—¶éªŒè¯ç”¨æˆ·æ´»è·ƒçŠ¶æ€
- **å¯†ç å¼ºåº¦è¦æ±‚** - å¤§å°å†™å­—æ¯å’Œæ•°å­—ç»„åˆ
- **ç™»å½•çŠ¶æ€è¿½è¸ª** - æœ€åç™»å½•æ—¶é—´è®°å½•

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ï¼š

```bash
# JWTé…ç½®
JWT_SECRET=your-super-secret-jwt-key-here
JWT_REFRESH_SECRET=your-super-secret-refresh-key-here
JWT_EXPIRES_IN=24h
JWT_REFRESH_EXPIRES_IN=7d

# å¯†ç åŠ å¯†é…ç½®
BCRYPT_SALT_ROUNDS=12

# åº”ç”¨é…ç½®
BASE_URL=http://localhost:3001
CORS_ORIGIN=http://localhost:3000
```

### 2. æ•°æ®åº“è¿ç§»

```bash
# ç”Ÿæˆæ•°æ®åº“è¿ç§»
pnpm db:generate

# åº”ç”¨è¿ç§»åˆ°æ•°æ®åº“
pnpm db:push

# é‡æ–°ç”Ÿæˆç§å­æ•°æ®
pnpm db:seed
```

## ğŸ“¡ APIæ¥å£ä½¿ç”¨

### 1. ç”¨æˆ·æ³¨å†Œ

```bash
curl -X POST http://localhost:3001/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "SecurePass123",
    "name": "å¼ ä¸‰",
    "avatar": "https://example.com/avatar.jpg"
  }'
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "user_123",
      "email": "user@example.com",
      "name": "å¼ ä¸‰",
      "avatar": "https://example.com/avatar.jpg",
      "role": "user",
      "createdAt": "2023-11-16T10:00:00.000Z"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresIn": 86400
  },
  "message": "æ³¨å†ŒæˆåŠŸ"
}
```

### 2. ç”¨æˆ·ç™»å½•

```bash
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "SecurePass123"
  }'
```

### 3. ä½¿ç”¨è®¿é—®ä»¤ç‰Œ

```bash
# è·å–ç”¨æˆ·ä¿¡æ¯
curl http://localhost:3001/api/auth/profile \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"

# åˆ›å»ºçµæ„Ÿï¼ˆéœ€è¦è®¤è¯ï¼‰
curl -X POST http://localhost:3001/api/ideas \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "content": "ä½¿ç”¨JWTè®¤è¯çš„æ–°çµæ„Ÿ",
    "tags": ["JWT", "è®¤è¯", "å®‰å…¨"]
  }'
```

### 4. åˆ·æ–°ä»¤ç‰Œ

```bash
curl -X POST http://localhost:3001/api/auth/refresh-token \
  -H "Content-Type: application/json" \
  -d '{
    "refreshToken": "YOUR_REFRESH_TOKEN"
  }'
```

### 5. ä¿®æ”¹å¯†ç 

```bash
curl -X POST http://localhost:3001/api/auth/change-password \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "oldPassword": "SecurePass123",
    "newPassword": "NewSecurePass456"
  }'
```

### 6. å¯†ç é‡ç½®

```bash
# è¯·æ±‚å¯†ç é‡ç½®
curl -X POST http://localhost:3001/api/auth/request-password-reset \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com"
  }'

# é‡ç½®å¯†ç 
curl -X POST http://localhost:3001/api/auth/reset-password \
  -H "Content-Type: application/json" \
  -d '{
    "token": "RESET_TOKEN_FROM_EMAIL",
    "password": "NewSecurePass456"
  }'
```

### 7. ç”¨æˆ·ç™»å‡º

```bash
curl -X POST http://localhost:3001/api/auth/logout \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

## ğŸ”§ è®¤è¯ä¸­é—´ä»¶ä½¿ç”¨

### 1. å¼ºåˆ¶è®¤è¯

```typescript
import { authenticateUser } from '@/middleware/auth'

// éœ€è¦ç™»å½•çš„è·¯ç”±
router.get('/protected', authenticateUser, (req, res) => {
  const user = req.user // å·²è®¤è¯çš„ç”¨æˆ·ä¿¡æ¯
  res.json({ user })
})
```

### 2. å¯é€‰è®¤è¯

```typescript
import { optionalAuth } from '@/middleware/auth'

// å¯é€‰ç™»å½•çš„è·¯ç”±ï¼ˆæ”¯æŒæ¸¸å®¢è®¿é—®ï¼‰
router.get('/public', optionalAuth, (req, res) => {
  const user = req.user // å¯èƒ½ä¸ºç©º
  res.json({ 
    isAuthenticated: !!user,
    user: user || null 
  })
})
```

### 3. è§’è‰²æƒé™æ§åˆ¶

```typescript
import { authenticateUser, requireAdmin } from '@/middleware/auth'

// åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®
router.post('/admin-only', 
  authenticateUser, 
  requireAdmin, 
  (req, res) => {
    res.json({ message: 'ç®¡ç†å‘˜åŠŸèƒ½' })
  }
)
```

### 4. å‘åå…¼å®¹ï¼ˆå¼€å‘æµ‹è¯•ï¼‰

```typescript
import { authenticateUserSimple } from '@/middleware/auth'

// ä½¿ç”¨ç®€åŒ–è®¤è¯ï¼ˆHeaderæ–¹å¼ï¼‰
router.get('/dev-test', authenticateUserSimple, (req, res) => {
  res.json({ user: req.user })
})
```

## ğŸ¯ å‰ç«¯é›†æˆç¤ºä¾‹

### 1. React Hookç¤ºä¾‹

```typescript
// useAuth.ts
import { useState, useEffect } from 'react'

interface User {
  id: string
  email: string
  name: string
  role: string
}

interface AuthState {
  user: User | null
  token: string | null
  isAuthenticated: boolean
  isLoading: boolean
}

export function useAuth() {
  const [authState, setAuthState] = useState<AuthState>({
    user: null,
    token: localStorage.getItem('access_token'),
    isAuthenticated: false,
    isLoading: true
  })

  // ç™»å½•
  const login = async (email: string, password: string) => {
    try {
      const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      })

      const data = await response.json()
      
      if (data.success) {
        localStorage.setItem('access_token', data.data.token)
        localStorage.setItem('refresh_token', data.data.refreshToken)
        
        setAuthState({
          user: data.data.user,
          token: data.data.token,
          isAuthenticated: true,
          isLoading: false
        })
      }
      
      return data
    } catch (error) {
      console.error('ç™»å½•å¤±è´¥:', error)
      throw error
    }
  }

  // ç™»å‡º
  const logout = async () => {
    try {
      const token = localStorage.getItem('access_token')
      if (token) {
        await fetch('/api/auth/logout', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        })
      }
    } catch (error) {
      console.error('ç™»å‡ºè¯·æ±‚å¤±è´¥:', error)
    } finally {
      localStorage.removeItem('access_token')
      localStorage.removeItem('refresh_token')
      setAuthState({
        user: null,
        token: null,
        isAuthenticated: false,
        isLoading: false
      })
    }
  }

  // éªŒè¯ä»¤ç‰Œ
  const verifyToken = async () => {
    const token = localStorage.getItem('access_token')
    if (!token) {
      setAuthState(prev => ({ ...prev, isLoading: false }))
      return
    }

    try {
      const response = await fetch('/api/auth/verify-token', {
        headers: { 'Authorization': `Bearer ${token}` }
      })

      if (response.ok) {
        const data = await response.json()
        setAuthState({
          user: data.data.user,
          token,
          isAuthenticated: true,
          isLoading: false
        })
      } else {
        // ä»¤ç‰Œæ— æ•ˆï¼Œå°è¯•åˆ·æ–°
        await refreshToken()
      }
    } catch (error) {
      console.error('ä»¤ç‰ŒéªŒè¯å¤±è´¥:', error)
      await logout()
    }
  }

  // åˆ·æ–°ä»¤ç‰Œ
  const refreshToken = async () => {
    const refreshToken = localStorage.getItem('refresh_token')
    if (!refreshToken) {
      await logout()
      return
    }

    try {
      const response = await fetch('/api/auth/refresh-token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ refreshToken })
      })

      if (response.ok) {
        const data = await response.json()
        localStorage.setItem('access_token', data.data.token)
        localStorage.setItem('refresh_token', data.data.refreshToken)
        
        setAuthState({
          user: data.data.user,
          token: data.data.token,
          isAuthenticated: true,
          isLoading: false
        })
      } else {
        await logout()
      }
    } catch (error) {
      console.error('åˆ·æ–°ä»¤ç‰Œå¤±è´¥:', error)
      await logout()
    }
  }

  useEffect(() => {
    verifyToken()
  }, [])

  return {
    ...authState,
    login,
    logout,
    refreshToken
  }
}
```

### 2. APIè¯·æ±‚æ‹¦æˆªå™¨

```typescript
// apiClient.ts
class ApiClient {
  private baseURL = process.env.REACT_APP_API_URL || 'http://localhost:3001'

  async request(endpoint: string, options: RequestInit = {}) {
    const token = localStorage.getItem('access_token')
    
    const config: RequestInit = {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...(token && { Authorization: `Bearer ${token}` }),
        ...options.headers
      }
    }

    let response = await fetch(`${this.baseURL}${endpoint}`, config)

    // å¦‚æœ401é”™è¯¯ï¼Œå°è¯•åˆ·æ–°ä»¤ç‰Œ
    if (response.status === 401 && token) {
      const refreshed = await this.refreshToken()
      if (refreshed) {
        // é‡è¯•åŸè¯·æ±‚
        config.headers = {
          ...config.headers,
          Authorization: `Bearer ${localStorage.getItem('access_token')}`
        }
        response = await fetch(`${this.baseURL}${endpoint}`, config)
      }
    }

    return response
  }

  private async refreshToken(): Promise<boolean> {
    const refreshToken = localStorage.getItem('refresh_token')
    if (!refreshToken) return false

    try {
      const response = await fetch(`${this.baseURL}/api/auth/refresh-token`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ refreshToken })
      })

      if (response.ok) {
        const data = await response.json()
        localStorage.setItem('access_token', data.data.token)
        localStorage.setItem('refresh_token', data.data.refreshToken)
        return true
      }
    } catch (error) {
      console.error('åˆ·æ–°ä»¤ç‰Œå¤±è´¥:', error)
    }

    return false
  }
}

export const apiClient = new ApiClient()
```

## ğŸ”„ è¿ç§»æŒ‡å—

### ä»ç®€åŒ–è®¤è¯å‡çº§åˆ°JWT

1. **ç°æœ‰ç”¨æˆ·æ•°æ®è¿ç§»**ï¼š
   ```sql
   -- ä¸ºç°æœ‰ç”¨æˆ·æ·»åŠ é‚®ç®±ï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
   UPDATE users SET email = id || '@temp.com' WHERE email IS NULL;
   
   -- è®¾ç½®é»˜è®¤è§’è‰²
   UPDATE users SET role = 'user' WHERE role IS NULL;
   
   -- æ¿€æ´»æ‰€æœ‰ç°æœ‰ç”¨æˆ·
   UPDATE users SET isActive = true WHERE isActive IS NULL;
   ```

2. **å‰ç«¯ä»£ç æ›´æ–°**ï¼š
   - æ›¿æ¢Headerè®¤è¯ä¸ºBearer Token
   - æ·»åŠ ä»¤ç‰Œåˆ·æ–°é€»è¾‘
   - æ›´æ–°ç™»å½•/æ³¨å†Œæµç¨‹

3. **å‘åå…¼å®¹**ï¼š
   - ç³»ç»ŸåŒæ—¶æ”¯æŒJWTå’ŒHeaderè®¤è¯
   - ä½¿ç”¨ `optionalAuth` ä¸­é—´ä»¶å¹³æ»‘è¿‡æ¸¡
   - é€æ­¥è¿ç§»å„ä¸ªæ¥å£

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **ä»¤ç‰Œæ— æ•ˆé”™è¯¯**
   ```bash
   # æ£€æŸ¥ä»¤ç‰Œæ ¼å¼
   echo "YOUR_TOKEN" | base64 -d
   
   # éªŒè¯ä»¤ç‰Œ
   curl http://localhost:3001/api/auth/verify-token \
     -H "Authorization: Bearer YOUR_TOKEN"
   ```

2. **å¯†ç å¼ºåº¦ä¸ç¬¦åˆè¦æ±‚**
   - å¯†ç å¿…é¡»è‡³å°‘8ä½
   - å¿…é¡»åŒ…å«å¤§å†™å­—æ¯ã€å°å†™å­—æ¯å’Œæ•°å­—
   - ç¤ºä¾‹ï¼š`SecurePass123`

3. **é‚®ç®±å·²å­˜åœ¨**
   - æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å·²æœ‰è¯¥é‚®ç®±
   - ä½¿ç”¨ä¸åŒé‚®ç®±æ³¨å†Œæˆ–è¿›è¡Œå¯†ç é‡ç½®

4. **åˆ·æ–°ä»¤ç‰Œå¤±æ•ˆ**
   - æ£€æŸ¥Redisè¿æ¥çŠ¶æ€
   - ç¡®è®¤åˆ·æ–°ä»¤ç‰Œæœªè¿‡æœŸ
   - é‡æ–°ç™»å½•è·å–æ–°ä»¤ç‰Œ

### è°ƒè¯•æ–¹æ³•

```typescript
// å¯ç”¨JWTè°ƒè¯•æ—¥å¿—
process.env.DEBUG = 'jwt'

// æ£€æŸ¥ä»¤ç‰Œå†…å®¹
const jwt = require('jsonwebtoken')
const decoded = jwt.decode(token, { complete: true })
console.log('ä»¤ç‰Œå†…å®¹:', decoded)
```

## ğŸ‰ æµ‹è¯•å®Œæˆæ ‡å¿—

å½“ä»¥ä¸‹åŠŸèƒ½æ­£å¸¸å·¥ä½œæ—¶ï¼Œè¯´æ˜è®¤è¯ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼š

âœ… ç”¨æˆ·å¯ä»¥æˆåŠŸæ³¨å†Œå’Œç™»å½•  
âœ… JWTä»¤ç‰Œæ­£ç¡®ç”Ÿæˆå’ŒéªŒè¯  
âœ… åˆ·æ–°ä»¤ç‰Œè‡ªåŠ¨æ›´æ–°ä¼šè¯  
âœ… å¯†ç ä¿®æ”¹å’Œé‡ç½®åŠŸèƒ½æ­£å¸¸  
âœ… è§’è‰²æƒé™æ§åˆ¶ç”Ÿæ•ˆ  
âœ… ç”¨æˆ·ä¿¡æ¯å¯ä»¥æ­£å¸¸æ›´æ–°  
âœ… ç™»å‡ºåŠŸèƒ½æ¸…é™¤ä¼šè¯  
âœ… å‘åå…¼å®¹æ€§ä¿æŒ  

**æ­å–œï¼æ‚¨çš„JWTè®¤è¯ç³»ç»Ÿå·²ç»å®Œå…¨å‡†å¤‡å°±ç»ªï¼** ğŸ”âœ¨
